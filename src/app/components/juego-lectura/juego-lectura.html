<!-- Announcement region for screen readers -->
<div aria-live="polite" aria-atomic="true" class="sr-only" role="status">
  <div *ngFor="let announcement of announcements">{{ announcement }}</div>
</div>

<!-- Header -->
<header class="header" role="banner">
    <div class="container">
        <div class="header-content">
            <div class="logo" tabindex="1" role="heading" aria-level="1">EnglishMaster</div>
            <nav class="header-actions" role="navigation" aria-label="Main navigation">
                <button class="btn btn-secondary" 
                        (click)="navigateToProfile()" 
                        tabindex="2"
                        aria-label="View user profile">
                    ğŸ‘¤ Profile
                </button>
                <button class="btn btn-primary" 
                        (click)="logout()" 
                        tabindex="3"
                        aria-label="Log out">
                    Logout
                </button>
            </nav>
        </div>
    </div>
</header>

<!-- Game Header -->
<section class="game-header" *ngIf="currentLectura" role="region" aria-label="Game information">
    <div class="container">
        <div class="game-info">
            <button class="btn btn-secondary back-btn" 
                    (click)="volverALecturas()" 
                    tabindex="4"
                    aria-label="Return to reading list">
                â† Back to Readings
            </button>
            <div class="reading-info">
                <h1 id="game-title">{{currentLectura.emoji}} {{currentLectura.titulo}}</h1>
                <span class="difficulty-badge" role="status">Reading Comprehension</span>
            </div>
        </div>
        
        <div class="game-stats" *ngIf="mostrarResultados" role="region" aria-label="Game results">
            <div class="stat-item score">
                <span class="stat-label">Score</span>
                <span class="stat-value" 
                      [class.excellent]="puntaje >= 80" 
                      [class.good]="puntaje >= 60 && puntaje < 80" 
                      [class.needs-improvement]="puntaje < 60"
                      [attr.aria-label]="'Score obtained: ' + puntaje + ' percent'">
                    {{puntaje}}%
                </span>
            </div>
        </div>
    </div>
</section>

<!-- Main Game Content -->
<main class="main game-main" *ngIf="currentLectura" id="main-content" role="main">
    <div class="container">
        <div class="game-layout">
            <!-- Context Section -->
            <section class="context-section" role="region" aria-labelledby="context-title">
                <h3 id="context-title">ğŸ“– Context in Spanish</h3>
                <div class="context-text" role="region" aria-describedby="context-title">
                    {{currentLectura.lecturaEspanol}}
                </div>
            </section>

            <!-- Game Section -->
            <section class="game-section" role="region" aria-label="Game area">
                <!-- Word Bank -->
                <div class="word-bank-section" role="region" aria-labelledby="word-bank-title">
                    <h4 id="word-bank-title">ğŸ“¦ Word Bank</h4>
                    <div class="word-bank-container" 
                         role="group" 
                         aria-label="Available words to drag"
                         aria-describedby="word-bank-instructions">
                        <p id="word-bank-instructions" class="sr-only">
                            Drag words from here to the blank spaces in the English text. 
                            You can also use keyboard navigation: arrow keys to navigate, Enter to select words, 
                            and keys 1-5 to jump to specific spaces.
                        </p>
                        <button 
                            *ngFor="let palabraDisp of palabrasDisponibles; let i = index"
                            class="word-chip"
                            [class.used]="palabraDisp.utilizada"
                            [class.dragging]="draggedIndex === i"
                            [class.keyboard-selected]="selectedWordIndex === i"
                            [class.selected]="wordSelected === palabraDisp.palabra"
                            [attr.aria-label]="'Word: ' + palabraDisp.palabra"
                            [attr.aria-pressed]="wordSelected === palabraDisp.palabra"
                            [attr.tabindex]="palabraDisp.utilizada ? '-1' : (5 + i)"
                            [style.display]="palabraDisp.utilizada ? 'none' : 'inline-block'"
                            draggable="true"
                            (click)="selectWord(palabraDisp.palabra, i)"
                            (keydown.enter)="selectWord(palabraDisp.palabra, i)"
                            (keydown.space)="selectWord(palabraDisp.palabra, i); $event.preventDefault()"
                            (dragstart)="onDragStart($event, palabraDisp.palabra, i)">
                            {{palabraDisp.palabra}}
                        </button>
                    </div>
                </div>

                <!-- English Exercise -->
                <div class="english-exercise" role="region" aria-labelledby="exercise-title">
                    <h4 id="exercise-title">ğŸ¯ Complete the English Text</h4>
                    <div class="english-paragraph" 
                         role="group" 
                         aria-label="Text to complete"
                         aria-describedby="exercise-instructions">
                        <p id="exercise-instructions" class="sr-only">
                            Complete the text by dragging the correct words to each blank space.
                            You can also use keyboard navigation: arrow keys to navigate, Enter to select,
                            Delete to remove words, and keys 1-5 to jump to specific spaces.
                        </p>
                        <ng-container *ngFor="let parte of currentLectura.lecturaIngles.split('_____'); let i = index">
                            {{parte}}
                            <div 
                                *ngIf="i < currentLectura.palabrasCompletar.length"
                                class="drop-zone"
                                [class.filled]="respuestasUsuario[i].palabraSeleccionada"
                                [class.correct]="juegoCompletado && esRespuestaCorrecta(i)"
                                [class.incorrect]="juegoCompletado && !esRespuestaCorrecta(i) && respuestasUsuario[i].palabraSeleccionada"
                                [class.keyboard-selected]="selectedDropZoneIndex === i"
                                [attr.aria-label]="'Blank space ' + (i + 1) + ' of ' + currentLectura.palabrasCompletar.length"
                                [attr.aria-describedby]="'drop-instructions-' + i"
                                [attr.data-position]="i + 1"
                                [attr.tabindex]="10 + i"
                                role="button"
                                (dragover)="onDragOver($event)"
                                (drop)="onDrop($event, i)"
                                (click)="handleDropZoneAction(i)"
                                (keydown.enter)="handleDropZoneAction(i)"
                                (keydown.space)="handleDropZoneAction(i); $event.preventDefault()">>
                                
                                <p [id]="'drop-instructions-' + i" class="sr-only">
                                    {{respuestasUsuario[i].palabraSeleccionada ? 
                                      'Space filled with: ' + respuestasUsuario[i].palabraSeleccionada + '. Press Enter to return the word.' : 
                                      'Empty space. Drag a word here or press ' + (i + 1) + ' to navigate here directly.'}}
                                </p>
                                
                                <span *ngIf="!respuestasUsuario[i].palabraSeleccionada" 
                                      class="placeholder"
                                      aria-hidden="true">
                                    {{i + 1}}
                                </span>
                                
                                <span *ngIf="respuestasUsuario[i].palabraSeleccionada" 
                                      class="placed-word"
                                      [attr.aria-label]="'Placed word: ' + respuestasUsuario[i].palabraSeleccionada"
                                      (click)="devolverPalabra(i)">
                                    {{respuestasUsuario[i].palabraSeleccionada}}
                                    <span class="remove-icon" 
                                          *ngIf="!juegoCompletado"
                                          aria-label="Remove word"
                                          role="button">Ã—</span>
                                </span>
                            </div>
                        </ng-container>
                    </div>
                </div>

                <!-- Game Controls -->
                <div class="game-controls" role="region" aria-label="Game controls">
                    <button 
                        class="btn btn-primary" 
                        (click)="verificarRespuestas()"
                        *ngIf="!juegoCompletado"
                        tabindex="20"
                        aria-label="Check exercise answers">
                        âœ… Check Answers
                    </button>
                    
                    <button 
                        class="btn btn-secondary" 
                        (click)="reiniciarJuego()"
                        *ngIf="juegoCompletado"
                        tabindex="21"
                        aria-label="Retry exercise">
                        ğŸ”„ Try Again
                    </button>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" 
                     *ngIf="mostrarResultados" 
                     role="region" 
                     aria-labelledby="results-title">
                <div class="results-container">
                    <h3 id="results-title" class="sr-only">Exercise results</h3>
                    <div class="score-display" 
                         [class.excellent]="puntaje >= 80" 
                         [class.good]="puntaje >= 60 && puntaje < 80" 
                         [class.needs-improvement]="puntaje < 60"
                         role="status"
                         [attr.aria-label]="'Final score: ' + puntaje + ' percent'">
                        <div class="score-number" aria-hidden="true">{{puntaje}}%</div>
                        <div class="feedback-text" role="status">
                            <span *ngIf="puntaje >= 80">Excellent work! ğŸ‰</span>
                            <span *ngIf="puntaje >= 60 && puntaje < 80">Good job! ğŸ‘</span>
                            <span *ngIf="puntaje < 60">Keep practicing ğŸ’ª</span>
                        </div>
                    </div>
                    
                    <!-- Correct Answers -->
                    <div class="correct-answers" role="region" aria-labelledby="correct-answers-title">
                        <h4 id="correct-answers-title">ğŸ“ Correct Answers:</h4>
                        <div class="answers-list" role="list">
                            <span *ngFor="let palabra of currentLectura.palabrasCompletar; let last = last" 
                                  class="correct-word"
                                  role="listitem">
                                {{palabra.palabra}}<span *ngIf="!last">, </span>
                            </span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="result-actions" role="group" aria-label="Post-game actions">
                        <button class="btn btn-primary" 
                                (click)="reiniciarJuego()" 
                                aria-label="Restart the same exercise">
                            ğŸ”„ Try Again
                        </button>
                        <button class="btn btn-secondary" 
                                (click)="volverALecturas()" 
                                aria-label="Return to choose another reading">
                            ğŸ“š Choose Another Reading
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>
</main>

<!-- Loading State -->
<div class="loading-state" *ngIf="!currentLectura">
    <div class="container">
        <div class="loading-content">
            <div class="loading-spinner">ğŸ“š</div>
            <p>Loading reading...</p>
        </div>
    </div>
</div>
